# ุงูุฎุทูุฉ 1: ุงุณุชูุฑุงุฏ ุงูููุชุจุงุช ุงููุงุฒูุฉ
import streamlit as st
import google.generativeai as genai
from ddgs import DDGS  # ุงุณุชูุฑุงุฏ ููุชุจุฉ ุงูุจุญุซ


# ----------------------------------------------------
# ุฏุงูุฉ ุงูุจุญุซ ุนู ุงูููุงูุณูู
@st.cache_data(ttl="1d", show_spinner=False)
def search_competitors(keyword):
    """
    ูุฐู ุงูุฏุงูุฉ ุชุจุญุซ ุนู ุงููููุฉ ุงูููุชุงุญูุฉ ูุชุนูุฏ ุฃูุถู 10 ูุชุงุฆุฌ.
    """
    try:
        with DDGS() as ddgs:
            # ูููู ุจุงูุจุญุซ ููุทูุจ 10 ูุชุงุฆุฌ ูุญุฏ ุฃูุตู
            results = list(ddgs.text(keyword, max_results=10))
            if not results:
                return ["ูู ูุชู ุงูุนุซูุฑ ุนูู ูุชุงุฆุฌ ุจุญุซ. ูุฏ ุชููู ููุงู ูุดููุฉ ูุคูุชุฉ ูู ุงูุงุชุตุงู."]
            return results
    except Exception as e:
        return [f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุจุญุซ: {e}"]


# ----------------------------------------------------
# ุฏุงูุฉ ุชูููุฏ ุงูุนูุงููู ุจุงุณุชุฎุฏุงู Google Gemini (ูุง ุชุบููุฑ ููุง)
@st.cache_data(ttl="1d", show_spinner=False)
def generate_gemini_titles(keyword, api_key):
    """
    ูุฐู ุงูุฏุงูุฉ ุชุชุตู ุจู Google AI ูุชุทูุจ ููู ุชูููุฏ ุนูุงููู ุฅุจุฏุงุนูุฉ.
    """
    try:
        genai.configure(api_key=api_key)

        prompt_template = f"""
        ุฃูุช ุฎุจูุฑ SEO ููุงุชุจ ูุญุชูู ูุญุชุฑู ูุชุฎุตุต ูู ูุชุงุจุฉ ุงูุนูุงููู ุงูุฌุฐุงุจุฉ ูุงููุชูุงููุฉ ูุน ูุญุฑูุงุช ุงูุจุญุซ.
        ูููุชู ูู ุชูููุฏ 10 ุนูุงููู ููุชุฑุญุฉ ูููุงู ุญูู ุงููููุฉ ุงูููุชุงุญูุฉ ุงูุชุงููุฉ: "{keyword}"

        ุฅุฑุดุงุฏุงุช ุชูููุฏ ุงูุนูุงููู:
        1.  **ุงูุชููุน:** ูุฌุจ ุฃู ุชููู ุงูุนูุงููู ูุชููุนุฉ (ุจุนุถูุง ุจุตูุบุฉ ุณุคุงูุ ุจุนุถูุง ุจุตูุบุฉ ูุงุฆูุฉุ ุจุนุถูุง ูุซูุฑ ุงููุถููุ ูุจุนุถูุง ูุจุงุดุฑ).
        2.  **ุงููููุฉ ุงูููุชุงุญูุฉ:** ูุฌุจ ุฃู ูุญุชูู ูู ุนููุงู ุนูู ุงููููุฉ ุงูููุชุงุญูุฉ ุงูุฑุฆูุณูุฉ ุฃู ูุฑุงุฏู ูุฑูุจ ูููุง.
        3.  **ุงูุฌุฐุจ:** ุงุณุชุฎุฏู ูููุงุช ูููุฉ ูุฃุฑูุงูุงู ูุฌุนู ุงูุนูุงููู ูุง ุชูุงูู (ูุซู: "ุฃุณุฑุงุฑ"ุ "ุฎุทูุงุช ุนูููุฉ"ุ "ูููุจุชุฏุฆูู"ุ "ูู 10 ุฏูุงุฆู").
        4.  **ุงููุถูุญ:** ูุฌุจ ุฃู ูููู ุงููุงุฑุฆ ุจูุถูุญ ูุง ุงูุฐู ุณูุญุตู ุนููู ูู ุงูููุงู.
        5.  **ุงููุชูุฌุฉ:** ุฃุฎุฑุฌ ุงูุนูุงููู ููุทุ ูู ุนููุงู ูู ุณุทุฑ ุฌุฏูุฏุ ุจุฏูู ุฃู ููุฏูุงุช ุฃู ุดุฑูุญุงุช ุฅุถุงููุฉ.
        """

        model = genai.GenerativeModel('models/gemini-2.5-flash')
        response = model.generate_content(prompt_template)

        content = response.text
        titles = content.strip().split('\n')
        cleaned_titles = [title.lstrip('0123456789.- ') for title in titles if title]
        return cleaned_titles

    except Exception as e:
        error_message = str(e)
        if "response.prompt_feedback" in error_message:
            return ["ุญุฏุซ ุฎุทุฃ: ุชู ุญุธุฑ ุงูุทูุจ ูุฃูู ูุฏ ูุญุชูู ุนูู ูุญุชูู ุบูุฑ ุขูู. ุญุงูู ุชุบููุฑ ุงููููุฉ ุงูููุชุงุญูุฉ."]
        return [f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจู Google AI: {e}"]


# ----------------------------------------------------
# ุงูุฎุทูุฉ 3: ุฅุนุฏุงุฏ ูุงุฌูุฉ ุงููุณุชุฎุฏู (ูุน ุงูุชุนุฏููุงุช ุงูุฌุฏูุฏุฉ)
st.set_page_config(layout="wide")  # ูุฌุนู ุงูุตูุญุฉ ุฃุนุฑุถ ููุชุงุฆุฌ ุงูุจุญุซ

st.title("ูุญุชูู ุจุฑู ๐ (ุฅุตุฏุงุฑ Gemini + Search)")
st.subheader("ุญูู ุงูููุงูุณูู ูุฃุจุฏุน ุจุนูุงููู ูุง ุชูุงูู")

# !!! ุถุน ููุชุงุญ Google AI ุงูุฎุงุต ุจู ููุง !!!
GOOGLE_API_KEY = "AIzaSyAD2Rc1lOxzgj61DeVT5lV9qPJ4RVJ7V_s"

keyword_input = st.text_input("ุฃุฏุฎู ุงููููุฉ ุงูููุชุงุญูุฉ ุงูุฑุฆูุณูุฉ ููุง:",
                              placeholder="ูุซุงู: ุฃูุถู ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุณููู ุงูุฑููู")

if st.button("ุญูู ูุฃุจุฏุน ุงูุขู!", type="primary"):
    if keyword_input:
        if GOOGLE_API_KEY == "YOUR_API_KEY":
            st.error("ุงูุฑุฌุงุก ูุถุน ููุชุงุญ Google AI API ุงูุฎุงุต ุจู ูู ุงูููุฏ ุฃููุงู.")
        else:
            # ูุณุชุฎุฏู ุงูุฃุนูุฏุฉ ูุนุฑุถ ุงููุชุงุฆุฌ ุจุดูู ููุธู
            col1, col2 = st.columns(2)

            # --- ุงูุนููุฏ ุงูุฃูู: ุชุญููู ุงูููุงูุณูู ---
            with col1:
                st.subheader("ุชุญููู ุงูููุงูุณูู (ุฃูุถู 10 ูุชุงุฆุฌ)")
                with st.spinner("ุฌุงุฑู ุงูุจุญุซ ุนู ุงูููุงูุณูู..."):
                    competitor_results = search_competitors(keyword_input)

                    if competitor_results and isinstance(competitor_results[0], dict):
                        st.success("ุชู ุงูุนุซูุฑ ุนูู ุงูููุงูุณูู!")
                        for i, result in enumerate(competitor_results):
                            st.markdown(f"**{i + 1}. [{result['title']}]({result['href']})**")
                            st.caption(result['body'][:150] + "...")  # ุนุฑุถ ููุชุทู ูู ุงููุญุชูู
                            st.divider()
                    else:
                        st.error(competitor_results[0])  # ุนุฑุถ ุฑุณุงูุฉ ุงูุฎุทุฃ

            # --- ุงูุนููุฏ ุงูุซุงูู: ุงูุนูุงููู ุงูููุชุฑุญุฉ ---
            with col2:
                st.subheader("ุนูุงููู ุฅุจุฏุงุนูุฉ ููุชุฑุญุฉ")
                with st.spinner("ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูููุฑ..."):
                    titles_list = generate_gemini_titles(keyword_input, GOOGLE_API_KEY)

                    if titles_list and not titles_list[0].startswith("ุญุฏุซ ุฎุทุฃ"):
                        st.success("ุชู ุชูููุฏ ุงูุนูุงููู ุจูุฌุงุญ!")
                        for title in titles_list:
                            st.markdown(f"๐ก {title}")
                    else:
                        st.error(titles_list[0])
    else:
        st.warning("ุงูุฑุฌุงุก ุฅุฏุฎุงู ูููุฉ ููุชุงุญูุฉ ุฃููุงู.")

